<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Illimat Integration Test</title>
    <style>
        body { font-family: monospace; background: #222; color: #eee; padding: 20px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .test-pass { background: #2d5a27; border: 1px solid #4caf50; }
        .test-fail { background: #5a2727; border: 1px solid #f44336; }
        .test-pending { background: #5a5727; border: 1px solid #ff9800; }
        #game-container { margin: 20px 0; min-height: 100px; border: 1px solid #555; }
    </style>
</head>
<body>
    <h1>üî¨ Illimat Interactive System Integration Test</h1>
    
    <div id="test-results"></div>
    
    <h2>Game Container:</h2>
    <div id="game-container">
        <div id="app"></div>
    </div>
    
    <script type="module">
        const testResults = document.getElementById('test-results');
        const gameContainer = document.getElementById('game-container');
        
        function addTestResult(name, status, message) {
            const div = document.createElement('div');
            div.className = `test-result test-${status}`;
            const icon = status === 'pass' ? '‚úÖ' : status === 'fail' ? '‚ùå' : '‚è≥';
            div.innerHTML = `${icon} <strong>${name}</strong>: ${message}`;
            testResults.appendChild(div);
        }
        
        async function runTests() {
            addTestResult('Test Suite', 'pending', 'Starting integration tests...');
            
            // Test 1: WASM Module Loading
            try {
                addTestResult('WASM Import', 'pending', 'Importing WASM module...');
                const wasmModule = await import('./pkg/illimat_core.js');
                addTestResult('WASM Import', 'pass', 'Module imported successfully');
                
                // Test 2: WASM Initialization
                addTestResult('WASM Init', 'pending', 'Initializing WebAssembly...');
                await wasmModule.default();
                wasmModule.init_panic_hook();
                addTestResult('WASM Init', 'pass', 'WebAssembly initialized');
                
                // Test 3: Game Engine Creation
                addTestResult('Game Engine', 'pending', 'Creating game engine...');
                const gameEngine = new wasmModule.WasmGameEngine(2);
                addTestResult('Game Engine', 'pass', 'Game engine created for 2 players');
                
                // Test 4: Game State Retrieval
                addTestResult('Game State', 'pending', 'Getting initial game state...');
                const stateJson = gameEngine.get_state_json();
                const gameState = JSON.parse(stateJson);
                addTestResult('Game State', 'pass', `Got game state: ${Object.keys(gameState).length} properties`);
                
                // Test 5: Current Player
                addTestResult('Current Player', 'pending', 'Getting current player...');
                const currentPlayer = gameEngine.get_current_player();
                addTestResult('Current Player', 'pass', `Current player: ${currentPlayer}`);
                
                // Test 6: Legal Moves
                addTestResult('Legal Moves', 'pending', 'Getting legal moves...');
                const legalMovesJson = gameEngine.get_legal_moves_json();
                const legalMoves = JSON.parse(legalMovesJson);
                addTestResult('Legal Moves', 'pass', `Found ${legalMoves.length} legal moves`);
                
                // Test 7: Move Validation
                addTestResult('Move Validation', 'pending', 'Testing move validation...');
                const sowValidation = gameEngine.validate_sow(0, 0, 1, 0); // Player 0, Field 0, Rank 1, Suit 0
                addTestResult('Move Validation', 'pass', `Sow validation: ${sowValidation.success ? 'valid' : 'invalid'}`);
                
                // Test 8: Vue App Loading (simplified)
                addTestResult('Vue Integration', 'pending', 'Testing Vue integration...');
                try {
                    // Import Vue and create a simple app to verify integration
                    const { createApp, ref } = await import('vue');
                    const app = createApp({
                        setup() {
                            const wasmReady = ref(true);
                            const gameEngineRef = ref(gameEngine);
                            return { wasmReady, gameEngine: gameEngineRef };
                        },
                        template: `
                            <div>
                                <div v-if="wasmReady" data-cy="game-interface">
                                    ‚úÖ WASM Ready - Current Player: {{ gameEngine.get_current_player() }}
                                </div>
                            </div>
                        `
                    });
                    app.mount('#app');
                    addTestResult('Vue Integration', 'pass', 'Vue app mounted with WASM integration');
                } catch (vueError) {
                    addTestResult('Vue Integration', 'fail', `Vue error: ${vueError.message}`);
                }
                
                // Summary
                addTestResult('Integration Test Suite', 'pass', 'All core functionality validated! üéâ');
                
                // Log game state for inspection
                console.log('üéÆ Game State:', gameState);
                console.log('üìã Legal Moves:', legalMoves);
                
            } catch (error) {
                addTestResult('Integration Test Suite', 'fail', `Error: ${error.message}`);
                console.error('Integration test error:', error);
            }
        }
        
        // Run tests when page loads
        runTests();
    </script>
</body>
</html>